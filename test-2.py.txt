import requests
from bs4 import BeautifulSoup
from telegram import (
    Bot, Update, ReplyKeyboardMarkup, KeyboardButton
)
from telegram.ext import (
    ApplicationBuilder, CommandHandler, MessageHandler,
    filters, ContextTypes, ConversationHandler
)

BOT_TOKEN = ''  # üëà Tokenni bu yerga yozing
CHANNEL_ID = ''  # üëà Kanal ID bu yerda kerak emas, faqat reply uchun

bot = Bot(token=BOT_TOKEN)

SEARCH_INPUT = 1


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE):
    keyboard = [[KeyboardButton("UzExdan qidiruv")]]
    markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
    await update.message.reply_text("Bo'limni tanlang:", reply_markup=markup)


async def handle_menu(update: Update, context: ContextTypes.DEFAULT_TYPE):
    if update.message.text == "UzExdan qidiruv":
        await update.message.reply_text("Kontrakt raqam va mahsulot nomini kiriting:\n\nMisol: 434395 –ö–∞—Ä–±–∞–º–∏–¥")
        return SEARCH_INPUT


async def perform_search(update: Update, context: ContextTypes.DEFAULT_TYPE):
    try:
        text = update.message.text.strip()
        parts = text.split(' ', 1)
        if len(parts) != 2:
            await update.message.reply_text("‚ùó Iltimos, formatni to'g'ri kiriting:\nMisol: 434395 –ö–∞—Ä–±–∞–º–∏–¥")
            return SEARCH_INPUT

        contract_number, product_name = parts
        search_url = f"https://www.uzex.uz/Trade/OffersSumNew?Page=1&Offset=0&Length=1000&Search={product_name}"
        response = requests.get(search_url, headers={'User-Agent': 'Mozilla/5.0'}, timeout=60)
        response.raise_for_status()

        soup = BeautifulSoup(response.text, 'html.parser')
        rows = soup.select('table tbody tr')

        for row in rows:
            cols = [td.text.strip() for td in row.select('td')]
            if cols and cols[0].strip() == contract_number:
                try:
                    hajm = int(cols[3].replace(" ", "").replace(",", ""))
                    soni = int(cols[6].replace(" ", "").replace(",", ""))
                    if hajm > 1000000:
                        hajm = hajm // 1000
                    umumiy = hajm * soni
                    hajm_text = f"({umumiy}) –∫–≥"
                except:
                    hajm_text = "(hajm topilmadi)"

                message = f"{cols[0]} {cols[1]} ({hajm_text})"
                await update.message.reply_text(message)
                return ConversationHandler.END

        await update.message.reply_text("‚ùå Kontrakt topilmadi.")
        return ConversationHandler.END

    except Exception as e:
        await update.message.reply_text(f"‚ö†Ô∏è Xatolik yuz berdi: {e}")
        return ConversationHandler.END


def main():
    app = ApplicationBuilder().token(BOT_TOKEN).build()

    conv_handler = ConversationHandler(
        entry_points=[MessageHandler(filters.TEXT & ~filters.COMMAND, handle_menu)],
        states={SEARCH_INPUT: [MessageHandler(filters.TEXT & ~filters.COMMAND, perform_search)]},
        fallbacks=[],
    )

    app.add_handler(CommandHandler("start", start))
    app.add_handler(conv_handler)

    print("ü§ñ Bot ishga tushdi.")
    app.run_polling()


if __name__ == "__main__":
    main()
